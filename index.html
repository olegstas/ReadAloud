<!DOCTYPE html>
<html>
<head>
    <title>Text Reader</title>
    <style>
        .highlight {
            background-color: yellow;
        }

        #voiceSelect {
            width: 200px;
        }

        #text {
            width: 100%;
            height: calc(100vh - 150px);
            border: 1px solid #ccc;
            padding: 10px;
            box-sizing: border-box;
            overflow: auto;
            white-space: pre-wrap;
            font-family: monospace;
            line-height: 1.5;
            margin-top: 10px;
        }

        body {
            margin: 0;
            padding: 10px;
            box-sizing: border-box;
        }

        .controls {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            align-items: center;
        }

        .repeat-controls {
            border: 1px solid #ccc;
            padding: 5px;
            border-radius: 4px;
        }
        
        #fileInput {
            max-width: 150px;
        }
    </style>
</head>
<body>
    <div class="controls">
        <input type="file" id="fileInput" accept=".txt,.html,.xml,.js,.css">
        <select id="languageSelect"></select>
        <select id="accentSelect"></select> 
        <select id="voiceSelect"></select>
        <select id="fontSizeSelect">
            <option value="12">12px</option>
            <option value="14">14px</option>
            <option value="16">16px</option>
            <option value="18">18px</option>
            <option value="20" selected>20px</option>
            <option value="22">22px</option>
            <option value="24">24px</option>
        </select>
        <label for="rateInput">Speed (0.1 - 10):</label>
        <input type="number" id="rateInput" min="0.1" max="10" step="0.1" value="1.0" style="width: 50px;">
        <button id="playButton">Play</button>
        <button id="stopButton" style="display: none;">Stop</button>
    </div>

    <div class="controls" style="margin-top: 10px;">
        <label for="loopCount">Full Text Loop:</label>
        <input type="number" id="loopCount" min="1" value="1" style="width: 40px;">

        <div class="repeat-controls">
            <label for="repeatUtteranceCheck">Repeat Mode (Sentence/Line/Selection):</label>
            <input type="checkbox" id="repeatUtteranceCheck">
            <label for="utteranceRepeatCount">Count:</label>
            <input type="number" id="utteranceRepeatCount" min="1" value="1" disabled style="width: 40px;">
            <label for="repeatInterval">Interval (ms):</label>
            <input type="number" id="repeatInterval" min="0" value="500" disabled style="width: 60px;">
            <label id="currentUtteranceRepeatCount" style="margin-left: 10px;"></label>
        </div>
    </div>

    <div id="text" contenteditable="true">Введіть тут свій текст для відтворення. (Текст у дужках буде проігноровано).

Якщо ввімкнено режим повтору (Repeat Mode), кожна строчка, відокремлена одним переходом рядка (Enter), буде читатися і повторюватися як єдиний блок.

Наприклад: 
Це перша строчка. Вона містить декілька речень.
Це друга строчка, яка буде повторюватись окремо.
</div>

    <script>
        // --- Core Variables ---
        const languageSelect = document.getElementById('languageSelect');
        const accentSelect = document.getElementById('accentSelect');
        const voiceSelect = document.getElementById('voiceSelect');
        const fontSizeSelect = document.getElementById('fontSizeSelect');
        const rateInput = document.getElementById('rateInput');
        const playButton = document.getElementById('playButton');
        const stopButton = document.getElementById('stopButton');
        const loopCountInput = document.getElementById('loopCount');
        const textElement = document.getElementById('text');
        const repeatUtteranceCheck = document.getElementById('repeatUtteranceCheck');
        const utteranceRepeatCountInput = document.getElementById('utteranceRepeatCount');
        const currentUtteranceRepeatCount = document.getElementById('currentUtteranceRepeatCount');
        const repeatIntervalInput = document.getElementById('repeatInterval');
        const fileInput = document.getElementById('fileInput'); // НОВЕ: Елемент завантаження файлу

        let speechSynthesis = window.speechSynthesis;
        let voices = [];
        let isCancelled = false;
        let originalText = '';
        let speechUnits = [];      
        let currentUnitIndex = 0;
        let currentUnitRepeatCount = 0;
        let fullLoopCount = 1;
        let isSelectionMode = false;

        // --- Utility Functions ---

        function cleanText(text) {
            // Видаляє текст у круглих дужках
            return text.replace(/\([^)]*\)/g, '').trim();
        }

        function splitIntoSentences(text) {
            return text.split(/(?<=[.!?])\s+/).filter(s => s.trim().length > 0);
        }
        
        function splitIntoLinesByNewline(text) {
            const normalizedText = text.replace(/\r/g, ''); 
            return normalizedText.split('\n').filter(s => s.trim().length > 0);
        }

        /**
         * Converts technical accent tags (e.g., 'en-US') to user-friendly names (e.g., 'English (USA)').
         */
        function getHumanReadableAccent(accentTag) {
            const parts = accentTag.split('-');
            const language = parts[0].toUpperCase();
            const region = parts.length > 1 ? parts[1].toUpperCase() : '';

            const regionNames = {
                'US': 'USA', 'GB': 'UK', 'CA': 'Canada', 'AU': 'Australia', 'IN': 'India',
                'IE': 'Ireland', 'FR': 'France', 'DE': 'Germany', 'UA': 'Україна', 
                'RU': 'Росія', 'IT': 'Італія', 'ES': 'Іспанія', 'JP': 'Японія',
                'KR': 'Корея', 'CN': 'Китай',
            };

            let langName;
            if (language === 'UK') langName = 'Українська';
            else if (language === 'EN') langName = 'English';
            else if (language === 'RU') langName = 'Русский';
            else if (language === 'FR') langName = 'Français';
            else langName = language;

            if (region) {
                return `${langName} (${regionNames[region] || region})`;
            }
            return langName;
        }


        // --- File Handling Function (НОВЕ) ---
        
        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();

            reader.onload = function(e) {
                // Вставляємо вміст файлу в редагований блок
                textElement.textContent = e.target.result;
                // Скидаємо елемент файлу, щоб можна було завантажити той самий файл знову
                fileInput.value = ''; 
            };

            reader.onerror = function() {
                alert('Не вдалося прочитати файл.');
            };

            // Читаємо файл як простий текст
            reader.readAsText(file); 
        }


        // --- Voice/Language Management ---

        window.speechSynthesis.onvoiceschanged = () => loadVoices();

        function loadVoices() {
            if (!('speechSynthesis' in window)) {
                textElement.innerHTML = 'Web Speech API is not supported in this browser.';
                return;
            }

            voices = speechSynthesis.getVoices();
            if (voices.length === 0) {
                setTimeout(loadVoices, 500); 
                return;
            }

            const baseLanguages = [...new Set(voices.map(voice => voice.lang.split('-')[0]))];
            languageSelect.innerHTML = '';
            baseLanguages.forEach(language => {
                const option = document.createElement('option');
                option.value = language;
                option.innerText = language.toUpperCase();
                languageSelect.appendChild(option);
            });

            const savedLanguage = localStorage.getItem('selectedLanguage') || 'uk'; 
            languageSelect.value = savedLanguage;
            
            updateAccents(savedLanguage);
        }

        function updateAccents(baseLanguage) {
            accentSelect.innerHTML = '';
            
            const filteredVoices = voices.filter(voice => voice.lang.startsWith(baseLanguage));
            const accents = [...new Set(filteredVoices.map(voice => voice.lang))];
            
            accents.forEach(accent => {
                const option = document.createElement('option');
                option.value = accent;
                option.innerText = getHumanReadableAccent(accent);
                accentSelect.appendChild(option);
            });

            const savedAccent = localStorage.getItem('selectedAccent') || accents[0];
            accentSelect.value = savedAccent;
            
            updateVoicesByAccent(savedAccent);
        }

        function updateVoicesByAccent(fullAccentTag) {
            voiceSelect.innerHTML = '';
            const filteredVoices = voices.filter(voice => voice.lang === fullAccentTag);

            filteredVoices.forEach(voice => {
                const option = document.createElement('option');
                option.value = voice.name;
                
                let displayName = voice.name;
                
                displayName = displayName.replace('Google', '').replace('Microsoft', '').trim();
                displayName = displayName.replace(new RegExp(`\\s*\\(${fullAccentTag}\\)`, 'i'), '').trim();
                
                option.innerText = displayName;
                if (voice.default) option.innerText += ' (default)';
                voiceSelect.appendChild(option);
            });

            const savedVoice = localStorage.getItem('selectedVoice');
            if (savedVoice && filteredVoices.find(voice => voice.name === savedVoice)) {
                voiceSelect.value = savedVoice;
            } else if (filteredVoices.length > 0) {
                 const defaultVoice = filteredVoices.find(v => v.default) || filteredVoices[0];
                 voiceSelect.value = defaultVoice.name;
            }
        }

        // --- Speech Logic (Core) ---

        function getCurrentSpeechUnitIndex() {
            if (isSelectionMode) return 0;
            const selection = window.getSelection();
            if (selection.rangeCount === 0) return 0;
            const range = selection.getRangeAt(0);
            const preCursorText = range.startContainer.textContent.substring(0, range.startOffset);
            const cleanedPreCursorText = cleanText(preCursorText);
            let charCount = 0;
            for (let i = 0; i < speechUnits.length; i++) {
                charCount += speechUnits[i].length;
                if (cleanedPreCursorText.length <= charCount) {
                    return i;
                }
            }
            return 0;
        }

        function highlightSpeechUnit(unitIndex) {
            unhighlightText();
            if (isSelectionMode) {
                const selection = window.getSelection();
                if (selection.rangeCount > 0) {
                    const range = selection.getRangeAt(0);
                    const span = document.createElement('span');
                    span.className = 'highlight';
                    if (range.commonAncestorContainer) {
                        try {
                            range.surroundContents(span);
                        } catch (e) {}
                    }
                }
                return;
            }
            const unitText = speechUnits[unitIndex];
            let startIndex = -1;
            let currentCursor = 0;
            const repeatEachUnit = repeatUtteranceCheck.checked;
            const isLineMode = repeatEachUnit && !isSelectionMode;
            const originalUnitsForMapping = isLineMode ? 
                originalText.replace(/\r/g, '').split('\n') : 
                originalText.split(/(?<=[.!?])\s+/);
            const originalUnits = originalUnitsForMapping.filter(s => s.trim().length > 0);

            for (let i = 0; i < originalUnits.length; i++) {
                const originalUnit = originalUnits[i].trim();
                const cleanedOriginalUnit = cleanText(originalUnit);
                
                if (cleanedOriginalUnit === unitText) {
                    startIndex = originalText.indexOf(originalUnit, currentCursor);
                    if (startIndex !== -1) {
                        const unitLength = originalUnit.length; 
                        const highlightedText = originalText.slice(0, startIndex) + 
                            '<span class="highlight">' + originalText.slice(startIndex, startIndex + unitLength) + '</span>' + 
                            originalText.slice(startIndex + unitLength);
                        textElement.innerHTML = highlightedText;
                        break;
                    }
                }
                const index = originalText.indexOf(originalUnit, currentCursor);
                if (index !== -1) {
                    currentCursor = index + originalUnit.length;
                } else {
                    currentCursor += originalUnit.length;
                }
            }
        }

        function unhighlightText() {
            textElement.innerHTML = textElement.textContent;
        }

        function Speak(utterance, delayMs) {
            if (!isCancelled) {
                setTimeout(() => {
                    speechSynthesis.speak(utterance);
                }, delayMs);
            }
        }

        function ReadTextBySentence() {
            isCancelled = false;
            originalText = textElement.textContent;
            const selectedText = window.getSelection().toString().trim();
            isSelectionMode = selectedText.length > 0;
            const repeatEachUnit = repeatUtteranceCheck.checked;
            const cleanedText = cleanText(originalText);
            
            if (isSelectionMode) {
                const cleanedSelection = cleanText(selectedText);
                if (cleanedSelection.length === 0) { stopReading(); return; }
                speechUnits = [cleanedSelection];
            } else if (repeatEachUnit) {
                speechUnits = splitIntoLinesByNewline(cleanedText); 
            } else {
                speechUnits = splitIntoSentences(cleanedText);
            }
            
            if (speechUnits.length === 0) {
                stopReading();
                return;
            }

            currentUnitIndex = getCurrentSpeechUnitIndex();
            currentUnitRepeatCount = 0;
            fullLoopCount = parseInt(loopCountInput.value) || 1;
            const maxUnitRepeats = parseInt(utteranceRepeatCountInput.value) || 1;
            const repeatIntervalMs = parseInt(repeatIntervalInput.value) || 500;
            
            currentUtteranceRepeatCount.textContent = repeatEachUnit ? `${currentUnitRepeatCount} / ${maxUnitRepeats}` : "";

            const selectedVoice = voices.find(voice => voice.name === voiceSelect.value);
            const rate = parseFloat(rateInput.value) || 1.0;
            
            const speakNext = (delay = 0) => {
                if (isCancelled) return;

                if (currentUnitIndex >= speechUnits.length) {
                    fullLoopCount--;
                    if (fullLoopCount > 0) {
                        currentUnitIndex = 0;
                        loopCountInput.value = fullLoopCount;
                        speakNext(repeatEachUnit ? repeatIntervalMs : 0);
                    } else {
                        stopReading();
                    }
                    return;
                }

                const unit = speechUnits[currentUnitIndex];
                const utterance = new SpeechSynthesisUtterance(unit);
                
                utterance.voice = selectedVoice;
                utterance.rate = rate;

                utterance.onstart = () => {
                    if (repeatEachUnit) {
                        currentUnitRepeatCount++;
                        let maxRepeatsDisplay = ` / ${maxUnitRepeats}`;
                        currentUtteranceRepeatCount.textContent = `${currentUnitRepeatCount}${maxRepeatsDisplay}`;
                    }
                    highlightSpeechUnit(currentUnitIndex);
                };

                utterance.onend = () => {
                    
                    if (repeatEachUnit && currentUnitRepeatCount < maxUnitRepeats) {
                        speakNext(repeatIntervalMs);
                        
                    } else {
                        currentUnitIndex++;
                        currentUnitRepeatCount = 0;

                        if (currentUnitIndex < speechUnits.length) {
                            speakNext(repeatEachUnit ? repeatIntervalMs : 0);
                        } else {
                            speakNext(0); 
                        }
                    }
                };
                
                Speak(utterance, delay);
            };
            
            speakNext();
        }
        
        function stopReading() {
            speechSynthesis.cancel();
            isCancelled = true;
            unhighlightText();
            stopButton.style.display = 'none';
            playButton.style.display = 'inline';
            loopCountInput.value = fullLoopCount; 
            currentUtteranceRepeatCount.textContent = "";
        }

        // --- Event Listeners ---

        window.addEventListener('load', loadVoices);
        
        languageSelect.addEventListener('change', function () {
            localStorage.setItem('selectedLanguage', this.value);
            updateAccents(this.value); 
        });

        accentSelect.addEventListener('change', function () {
            localStorage.setItem('selectedAccent', this.value);
            updateVoicesByAccent(this.value); 
        });

        voiceSelect.addEventListener('change', function () {
            localStorage.setItem('selectedVoice', this.value);
        });

        fontSizeSelect.addEventListener('change', function () {
            textElement.style.fontSize = `${this.value}px`;
        });
        repeatUtteranceCheck.addEventListener('change', function () {
            utteranceRepeatCountInput.disabled = !this.checked;
            repeatIntervalInput.disabled = !this.checked;
            currentUtteranceRepeatCount.textContent = this.checked ? "0 / 1" : "";
        });

        playButton.addEventListener('click', function () {
            speechSynthesis.cancel(); 
            playButton.style.display = 'none';
            stopButton.style.display = 'inline';
            ReadTextBySentence();
        });

        stopButton.addEventListener('click', stopReading);

        // НОВИЙ ОБРОБНИК: Обробка завантаження файлу
        fileInput.addEventListener('change', handleFileSelect);

    </script>
</body>
</html>
